<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">

<meta name="hexo-config" content="{&quot;hostname&quot;:&quot;www.udnz.com&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;right&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;slideDownIn&quot;,&quot;post_body&quot;:&quot;slideDownIn&quot;,&quot;coll_header&quot;:&quot;slideLeftIn&quot;,&quot;sidebar&quot;:&quot;slideUpIn&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;/search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}">
<meta name="description" content="架构师，腾讯专注微服务和软件基础设施建设">
<meta property="og:type" content="website">
<meta property="og:title" content="UDNZ">
<meta property="og:url" content="https://www.udnz.com/index.html">
<meta property="og:site_name" content="UDNZ">
<meta property="og:description" content="架构师，腾讯专注微服务和软件基础设施建设">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Austin Luo">
<meta property="article:tag" content=".net, architecture, architect, micro-service, soa, istio, k8s, kubernetes, dotnet, .net core, c#">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.udnz.com/">



<meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;}">
<meta name="hexo-config-calendar" content="">
<title>UDNZ</title><script data-pjax src="/js/load-config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="UDNZ" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">UDNZ</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">28</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">18</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Austin Luo"
      src="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
  <p class="site-author-name" itemprop="name">Austin Luo</p>
  <div class="site-description" itemprop="description">架构师，腾讯<br />专注微服务和软件基础设施建设</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/uonun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;uonun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bitbucket.org/uonun/" title="Bitbucket → https:&#x2F;&#x2F;bitbucket.org&#x2F;uonun&#x2F;" rel="noopener" target="_blank"><i class="fab fa-bitbucket fa-fw"></i>Bitbucket</a>
      </span>
      <span class="links-of-author-item">
        <a target="_blank" rel="noopener" href="//shang.qq.com/wpa/qunwpa?idkey=2aa3ef00102d1db4f2275d835aabf3eb043e8ba7b22ead791ba469cdb198a8cc" title="QQ 群 → &#x2F;&#x2F;shang.qq.com&#x2F;wpa&#x2F;qunwpa?idkey&#x3D;2aa3ef00102d1db4f2275d835aabf3eb043e8ba7b22ead791ba469cdb198a8cc"><i class="qq fa-fw"></i>QQ 群</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2021/04/10/Nginx-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/10/Nginx-%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/" class="post-title-link" itemprop="url">Nginx 安装部署及安全加固</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-10 11:58:21" itemprop="dateCreated datePublished" datetime="2021-04-10T11:58:21+08:00">2021-04-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http://nginx.org/en/linux_packages.html#RHEL-CentOS</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[nginx-stable]</span></span><br><span class="line"><span class="string">name=nginx stable repo</span></span><br><span class="line"><span class="string">baseurl=http://nginx.org/packages/centos/\$releasever/\$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class="line"><span class="string">module_hotfixes=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[nginx-mainline]</span></span><br><span class="line"><span class="string">name=nginx mainline repo</span></span><br><span class="line"><span class="string">baseurl=http://nginx.org/packages/mainline/centos/\$releasever/\$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class="line"><span class="string">module_hotfixes=true&quot;</span> &gt; /etc/yum.repos.d/nginx.repo</span><br><span class="line"></span><br><span class="line">yum-config-manager --<span class="built_in">enable</span> nginx-mainline</span><br><span class="line">yum install nginx</span><br><span class="line"></span><br><span class="line">systemctl start nginx <span class="comment">#启动</span></span><br><span class="line">systemctl restart nginx <span class="comment">#重启</span></span><br><span class="line">systemctl stop nginx   <span class="comment">#终止</span></span><br><span class="line">systemctl <span class="built_in">enable</span> nginx  <span class="comment">#开机自启</span></span><br><span class="line">systemctl <span class="built_in">disable</span> nginx   <span class="comment">#禁止开机自启</span></span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="附加站点配置目录"><a href="#附加站点配置目录" class="headerlink" title="附加站点配置目录"></a>附加站点配置目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份并修改配置文件</span></span><br><span class="line">cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak</span><br><span class="line">mkdir -p /data/workspace/settings/vhost</span><br><span class="line">ln -s /data/workspace/settings/vhost /etc/nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"><span class="addition">+   include /etc/nginx/vhost/*.conf;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h2><h3 id="编辑默认页面"><a href="#编辑默认页面" class="headerlink" title="编辑默认页面"></a>编辑默认页面</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;Welcome&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;Welcome&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;50x Error&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;50x Error&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;&quot;</span> &gt; /usr/share/nginx/html/50x.html</span><br></pre></td></tr></table></figure>

<h3 id="删除如下配置信息"><a href="#删除如下配置信息" class="headerlink" title="删除如下配置信息"></a>删除如下配置信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;doc &#123;</span><br><span class="line">  root &#x2F;usr&#x2F;share;</span><br><span class="line">  autoindex on;</span><br><span class="line">  allow 127.0.0.1;</span><br><span class="line">  deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location &#x2F;images &#123;</span><br><span class="line">  root &#x2F;usr&#x2F;share;</span><br><span class="line">  autoindex off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="隐藏-nginx-版本信息"><a href="#隐藏-nginx-版本信息" class="headerlink" title="隐藏 nginx 版本信息"></a>隐藏 nginx 版本信息</h3><p>打开配置文件 隐藏版本设置 Server_tokens off;</p>
<h3 id="禁用非必要的请求方法"><a href="#禁用非必要的请求方法" class="headerlink" title="禁用非必要的请求方法"></a>禁用非必要的请求方法</h3><p>trace 请求用于网络诊断，会暴露信息，只允许 GET、HEAD、POST 请求，其他请求直接返回 444 状态码 （444 是 nginx 定义的响应状态码，会立即断开连接，没有响应正文，TRACE 请求 nginx 内置 405 拒绝）</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($request_method !~ ^(GET|<span class="type">HEAD</span>|<span class="type">POST</span>)$ ) &#123; <span class="keyword">return</span> <span class="number">444</span>; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="隐藏-X-powered-by-信息"><a href="#隐藏-X-powered-by-信息" class="headerlink" title="隐藏 X-powered-by 信息"></a>隐藏 X-powered-by 信息</h3><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_hide_header <span class="meta">X</span>-Powered-<span class="meta">By</span>;</span><br><span class="line">fastcgi_hide_header <span class="meta">X</span>-Powered-<span class="meta">By</span>;</span><br></pre></td></tr></table></figure>

<h3 id="禁止-SSLv3-协议"><a href="#禁止-SSLv3-协议" class="headerlink" title="禁止 SSLv3 协议"></a>禁止 SSLv3 协议</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_protocols</span> TLSv<span class="number">1</span> TLSv<span class="number">1</span>.<span class="number">1</span> TLSv<span class="number">1</span>.<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-   #gzip  on;</span></span><br><span class="line"><span class="addition">+   gzip  on;</span></span><br><span class="line"><span class="addition">+   autoindex off</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2019/08/20/%E8%A7%A3%E5%86%B3-systemd-journald-%E6%9C%8D%E5%8A%A1%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98%E8%BF%87%E9%AB%98%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/20/%E8%A7%A3%E5%86%B3-systemd-journald-%E6%9C%8D%E5%8A%A1%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98%E8%BF%87%E9%AB%98%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">解决 systemd-journald 服务占用内存过高的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-20 19:43:44" itemprop="dateCreated datePublished" datetime="2019-08-20T19:43:44+08:00">2019-08-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="解决-systemd-journald-服务占用内存过高的问题"><a href="#解决-systemd-journald-服务占用内存过高的问题" class="headerlink" title="解决 systemd-journald 服务占用内存过高的问题"></a>解决 systemd-journald 服务占用内存过高的问题</h1><h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>生产环境机器发现内存占用很高：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node132 /run/log/journal]# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           125G         87G         10G        323M         27G         36G</span><br><span class="line">Swap:            0B          0B          0B</span><br></pre></td></tr></table></figure>

<p>排查发现，是 systemd-journal 占用了过高的内存：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@node173 /run/log/journal]# top -o %MEM -n 1 -b | head -n17</span><br><span class="line">top - 16:29:45 up 167 days, 15:01,  1 user,  load average: 0.15, 0.20, 0.29</span><br><span class="line">Tasks: 623 total,   2 running, 621 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.4 us,  0.2 sy,  0.0 ni, 99.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 13138539+total,  2088144 free, 93968128 used, 35329120 buff/cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used. 36300876 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 6764 root      20   0   81.8g  81.7g   5580 S   0.0 65.2 693:59.06 systemd-journal</span><br><span class="line">18038 root      20   0   34.9g 976.9m  14360 S   0.0  0.8  43:07.76 java</span><br><span class="line"> 8386 root      20   0 8070328 806540  17436 S   0.0  0.6   5347:53 dockerd-current</span><br><span class="line"> 8442 root      20   0 5189372 540292   4600 S   0.0  0.4 537:15.83 docker-containe</span><br><span class="line"> 5792 root      20   0 2302960 374132   8976 S   0.0  0.3 709:40.18 java</span><br><span class="line">20023 root      20   0 2173620 339624   8976 S   0.0  0.3  63:39.12 java</span><br><span class="line">41196 root      20   0 7651664 323728   9880 S   0.0  0.2  37077:57 cadvisor</span><br><span class="line">11116 root      20   0 5099056 317780  15268 S   0.0  0.2  19:47.50 java</span><br><span class="line">35339 root      20   0 2149764 311520   9008 S   0.0  0.2  56:52.01 java</span><br><span class="line">18662 root      20   0 4730832 190692  36380 S   0.0  0.1   8338:20 kubelet</span><br></pre></td></tr></table></figure>

<p>查看相关配置发现，systemd-journal 服务没有启用持久化，日志保留在内存，因此只需要启用持久化即可解决该问题。</p>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p><strong>1. 首先将日志目录移动到 /data 路径下</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/<span class="built_in">log</span></span><br><span class="line">mv /var/<span class="built_in">log</span>/* /data/<span class="built_in">log</span>/</span><br><span class="line">rm -r /var/<span class="built_in">log</span></span><br><span class="line"><span class="comment"># 重定向整个日志目录到 /data/log</span></span><br><span class="line">ln -s /data/<span class="built_in">log</span> /var</span><br></pre></td></tr></table></figure>

<p><strong>2. 修改服务配置，重启服务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/journald.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置并取消注释以下几项</span></span><br><span class="line">Storage=persistent</span><br><span class="line">SystemMaxUse=4G</span><br><span class="line">SystemMaxFileSize=1G</span><br><span class="line">RuntimeMaxUse=2G</span><br><span class="line">RuntimeMaxFileSize=1G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl restart systemd-journald</span><br></pre></td></tr></table></figure>

<p>重启服务后，日志将会被直接持久化到磁盘，不再占用过多内存。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sparkdev/p/8795141.html">https://www.cnblogs.com/sparkdev/p/8795141.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.steamedfish.org/posts/2019/06/systemd-journal-%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98/">https://blog.steamedfish.org/posts/2019/06/systemd-journal-%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98%E7%9A%84%E9%97%AE%E9%A2%98/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2019/08/20/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%92%8C%E7%B3%BB%E7%BB%9F%E4%BF%9D%E6%8A%A4%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/20/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E5%92%8C%E7%B3%BB%E7%BB%9F%E4%BF%9D%E6%8A%A4%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">系统安全和系统保护设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-20 19:28:11" itemprop="dateCreated datePublished" datetime="2019-08-20T19:28:11+08:00">2019-08-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="系统安全和系统保护设计"><a href="#系统安全和系统保护设计" class="headerlink" title="系统安全和系统保护设计"></a>系统安全和系统保护设计</h1><p>要保证数据安全和系统稳定可用，我们应当全方位地对系统进行保护，这里主要分为两个层面。</p>
<p>一是系统的安全方面，这主要是面向非法入侵、非法请求的。我们需要阻止和屏蔽不信任的请求源访问，我们要保证数据的安全可靠，不被人窃取。</p>
<p>二是系统的健壮性方面，面向合法、信任的请求源，为了保证系统的可用性，我们需要在请求并发高于系统设计容量时，拦截和丢弃超载的请求（有损服务），以避免因为请求过大发生雪崩效应，导致整个系统都不可用。</p>
<h2 id="第一部分：系统安全设计"><a href="#第一部分：系统安全设计" class="headerlink" title="第一部分：系统安全设计"></a>第一部分：系统安全设计</h2><p>对于系统的安全防范，需要从全方位、多角度做工作，以确保整个业务链路、整个体系范围都能保证安全。以下就从多个角度来说明如何进行系统安全设计。</p>
<h3 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h3><ul>
<li><p>传输加密</p>
<p>我们一般开放 Web 访问，走 HTTP 协议。要对外公开接口或页面时，面向外网应当以 HTTPS 的形式公开。</p>
</li>
<li><p>网络隔离</p>
<p>通过网络互不连通来防止入侵，这是最严格也是最暴力的安全解决方案。在我们的生产实践中，主要体现在如下几个方面：</p>
<ul>
<li>不公开服务的机器，不分配外网 IP</li>
<li>办公网络和生产网络相互不可以直接通信</li>
</ul>
</li>
<li><p>网关</p>
<p>在我们需要对外公开 HTTP/HTTPS 接口时，需要使用网关收敛对外公开的接触面。设计独立的接入层专门负责网络请求的接入，不得将非接入层的机器公开出去。</p>
</li>
<li><p>容器</p>
<p>我们的应用目前主要基于容器部署。在启动容器时，我们应当为每个不同的项目创建和指定不同的网络，从而隔离不同的项目服务。</p>
</li>
</ul>
<h3 id="认证安全"><a href="#认证安全" class="headerlink" title="认证安全"></a>认证安全</h3><p>对于使用应用的实体，无论是人还是系统程序，都应当做到对每个请求都应当能找到对应的责任实体。因此，面向人我们需要做到严格的登录鉴权，面向应用我们应当做到严格的接口签名和数据校验。我们通常将这一层称之为 ACL（Access Control Layer）。</p>
<h4 id="登录鉴权"><a href="#登录鉴权" class="headerlink" title="登录鉴权"></a>登录鉴权</h4><p>目前能够落地实践的方案，有如下几个值得推荐：</p>
<table>
<thead>
<tr>
<th>群体</th>
<th>外网</th>
<th>内网</th>
</tr>
</thead>
<tbody><tr>
<td>员工</td>
<td>接入 OA 登录</td>
<td>接入 OA 登录</td>
</tr>
<tr>
<td>外部用户</td>
<td>接入微信、企业微信、QQ 登录</td>
<td><em>不允许外部用户直接登录/访问内网(*)</em></td>
</tr>
</tbody></table>
<blockquote>
<p>TIP: 不允许外部用户直接登录内网，必需在外网部署登录验证服务，验证通过之后，才能由外网的服务通过应用网关发起对 OA 服务的请求。所有外部请求均只落到外网区域，不允许通过反向代理将请求直接转发到应用网关继而将未经过登录验证的请求路由到 OA 服务器上。</p>
</blockquote>
<p>如果要自建登录验证模块，那么需要注意如下几个方面：</p>
<ul>
<li>登录页面/登录接口应当有防刷机制（比如验证码），防止机器暴力破解。</li>
<li>应当具备随机登录因子（比如 token、短信验证码），降低密码泄露的后果影响。</li>
<li>多次登录尝试失败之后，应当锁定账户或 IP，不再允许登录。</li>
<li>采用增强的密码管理策略，如拒绝弱密码、密码最小长度要求、字符集要求、定期更改密码要求等等。</li>
</ul>
<h4 id="登录态管理"><a href="#登录态管理" class="headerlink" title="登录态管理"></a>登录态管理</h4><p>我们的服务大多需要集群部署，因此需要是无状态的。虽然智能网关和大多数反向代理一样都支持有状态服务，但为了管理方便和更高的可扩展性，我们的最佳实践是保证开发部署的所有业务服务都是无状态的。而登录态本身是有状态的，因此登录态本身需要从业务服务中剥离出来，以避免导致有状态服务的出现。此时我们通常会将登录凭据保存到 Redis 中。因此，我们需要要求：</p>
<ul>
<li>登录态应当独立存储</li>
<li>Redis 配置密码，并对客户端进行 IP 限制</li>
</ul>
<p>另一方面，业务侧从 ACL 拿到登录凭据之后，需要注意如下两个方面：</p>
<ul>
<li>不得将登录凭据（如 access_token、refresh_token）等泄露到客户端（包括 cookie、url 跳转等），更不得将员工真实 ID 泄露到客户端。<ul>
<li>推荐的方式是业务侧生成临时的、指代当前登录身份的 hash 值，以该 hash 值为凭据与客户端交互。</li>
</ul>
</li>
<li>对当前用户身份，不得信任传入的外部信息。需要身份信息之后，必须经过验证后从 ACL 获取。</li>
</ul>
<h3 id="应用安全"><a href="#应用安全" class="headerlink" title="应用安全"></a>应用安全</h3><ul>
<li><p>请求签名</p>
<p>我们应当始终对外部请求持谨慎态度，包括请求的来源，请求的数据，都要进行谨慎的处理。只有通过接口签名验证的请求，才信任为合法的请求。</p>
<p>对请求的接口签名设计，可参考学习 QQ、微信的相关接口。也可直接接入应用网关，使用应用网关的签名机制。我们也可以设计自己的接口签名算法，但需要重点保证用来签名的关键信息（如 app_secret）不得通过请求本身传递，也要告知和约束用户保证用来签名的关键信息不得泄露。</p>
<blockquote>
<p>TIP: 对请求签名除了保证能区分合法和非法请求，也能通过签名追述每一次请求具体的来源应用。</p>
</blockquote>
</li>
<li><p>数据加密</p>
<p>对于敏感数据，不得明文传输和明文存储。</p>
<p>对外方面，不得明文传输。我们可以采用 map hash 的方式做映射，如 ACL 返回的身份凭据，我们不应当直接写入客户端 Cookie，而是应当生成临时 hash，以映射的关系与客户端关联；也可以对数据本身进行加密传输，如启用 HTTPS，或者将关键信息通过加密之后再传输。</p>
<p>对内方面，不得明文存储。我们可以加密后再存储，如密码；也可以直接脱敏处理，如日志。</p>
</li>
<li><p>容器</p>
<p>在我们打包容器时，应当使用安全可靠的基础镜像进行打包。</p>
</li>
</ul>
<h3 id="运维安全"><a href="#运维安全" class="headerlink" title="运维安全"></a>运维安全</h3><p>理想状况下我们不应当登录服务器进行任何操作，但实际生产却不是这样的。由于运维工具功能的不完善和滞后性，我们往往不得不直接登录到服务器上去直接执行命令，进行日志维护、服务进程维护、服务器维护等操作。由于已经直接触达服务器本身，因此这也是整个系统安全最高危的部分。</p>
<ul>
<li><p>运行账户</p>
<p>为减少由于我们的服务被攻击之后造成的损失，减小影响面。在运行应用时，不得以 root 权限运行，而应当另外创建专有用户，并授予最小权限。这样即使应用本身被攻击成功，黑客也需要有一个提权的过程，提高了攻击的门槛。</p>
</li>
<li><p>运维账户和运维审计</p>
<p>对于运维操作，账户本身应当得到严密的管控，严密管控 root 账号。每一个运维人员都应该采用实名登录，并且在每一次登录、操作、登出都进行完善的记录以备审计。</p>
<p>对于高危操作，需要提升运维人员的意识，避免发生由于粗心大意造成的严重后果。</p>
</li>
<li><p>高危命令</p>
<p>谨慎执行高危命令，在必要时使用<code>alias</code>指令重命名高危命令。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/52597369">Linux 里 10 个最危险的命令</a></li>
<li><a target="_blank" rel="noopener" href="https://apple.stackexchange.com/questions/17622/how-can-i-make-rm-move-files-to-the-trash-can">How can I make ‘rm’ move files to the trash can?</a></li>
</ul>
</li>
</ul>
<h3 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h3><p>数据的安全是重中之重，以上所有的措施其根本也都是为了保证数据的安全。同时，对于数据本身，我们还有一些可以做的事情。</p>
<ul>
<li><p>容器隔离</p>
<p>容器化部署时，我们往往会挂载外部目录到容器中。此时我们应当确保：</p>
<ul>
<li>尽可能使用稳定、可靠的云存储，避免单机故障</li>
<li>同一个挂载目录不应当跨容器共享，而应当由单个容器独占</li>
</ul>
</li>
<li><p>租户隔离</p>
<p>随着 SaaS 化系统越来越多，我们也采用了更多的多租户设计。在系统交互、数据读写方面，务必强要求区分租户。不得因为租户信息被泄露，导致跨租户的其他数据被泄露，必须严控影响面。</p>
</li>
<li><p>离线票据</p>
<p>跨系统交互时，我们可能会涉及到一些敏感票据，比如 app_key/app_secret、pub_key/private_key 等。其中往往 app_key、pub_key 是公开的，允许通过请求传递，而 app_secret、private_key 是需要严格保密的，不得直接通过请求传递。对于这些需要严格保密的敏感票据，应当通过线下、脱离于当前系统的方式进行传递，如打印并邮寄，如单独的、人工的邮件等等。</p>
</li>
<li><p>日志脱敏</p>
<p>日志的敏感性是很容易被忽略的。可能我们花了很大的力气做了系统安全加固，缺忘记了日志里往往也存在大量的敏感信息，导致信息通过日志被泄露了。那么在开发时，我们需要时刻注意日志内容，不应当有敏感信息。在日志传输和存储时，也应当对日志内容进行脱敏。</p>
</li>
<li><p>数据备份</p>
<p>和日志一样，数据的备份文件也是容易被忽视的地方，我们应当花足够大的精力来保证备份文件不被窃取。</p>
</li>
</ul>
<h3 id="政策合规"><a href="#政策合规" class="headerlink" title="政策合规"></a>政策合规</h3><p>对于我们的业务来讲，政策合规性一般不存在问题。但从设计上，也应当留有多个方面的合规审计空间。</p>
<ul>
<li><p>操作审计</p>
<p>记录用户的操作对象和操作历史。</p>
</li>
<li><p>权限审计</p>
<p>对权限的分配和变更，做严格的控制和记录，避免授予的权限不必要的扩大。同时对于已经失效的用户，应当即使回收权限。</p>
</li>
<li><p>数据审计</p>
<p>对关键数据的读、写，都应当有权限和审批流程进行控制。实际的示例比如 HRC 和 TOF 中，对员工信息的读取，是需要进行权限申请和审批的。</p>
</li>
<li><p>敏感词审计</p>
<p>应当接入或建立敏感词库，对于 UGC 内容，务必确保拦截和过滤敏感词，以避免不合规的内容展示到系统中，导致政策和舆论风险。</p>
</li>
</ul>
<h2 id="第二部分：系统保护设计"><a href="#第二部分：系统保护设计" class="headerlink" title="第二部分：系统保护设计"></a>第二部分：系统保护设计</h2><p>对系统的保护，主要是要使得系统具有更高的健壮性（鲁棒性），要求系统在输入错误、磁盘故障、网络过载或有意攻击情况下，能否不死机、不崩溃。这其中包含的内容较为广泛，可做的事情也很多，此处只简略说两个部分。</p>
<h3 id="防御性设计"><a href="#防御性设计" class="headerlink" title="防御性设计"></a>防御性设计</h3><p>除了代码及的防御性编程，我们还应当有接口层面的保护。这方面主要致力于解决在网络过载情况下的防护，不至于因为客户端密集高并发调用时，拖垮整个系统，影响接入平台的其他应用。</p>
<p>目前常规的做法是基于微服务架构设计，接入 api 网关来做接口保护。包括“腾讯里约”、“ASF”在内，以及市面上的大多数成熟 api 网关都有相关的功能：</p>
<ul>
<li>IP 白名单</li>
<li>消费者鉴权</li>
<li>消费限额</li>
<li>快速拒绝</li>
<li>服务 QPS 预警和限制</li>
<li>服务熔断</li>
<li>防重复</li>
<li>接口缓存</li>
</ul>
<blockquote>
<p>TIP: 成熟的 Api 网关不仅具有上述功能，一般还具有自定义路由、健康检查、高可用接入、协议适配等其他功能。</p>
</blockquote>
<p>有了以上功能，我们的服务在需要提供给外部系统访问时就可以通过 api 网关来公开，使得所有进入的请求都流经 api 网关。实际操作上，我们对自身业务系统的容量有了合理评估之后，可以在 api 网关上设置合适的阈值。</p>
<p>通过配置 IP 白名单、消费者鉴权，可以将非法的请求拒之门外；</p>
<p>通过配置消费限额、快速拒绝，可以将过量的、非预期的请求拒之门外，同时避免（通过了消费鉴权的请求）消耗无谓的系统资源；</p>
<p>通过配置服务 QPS 预警和限制，可以在服务能力即将达到临界时，向运维人员发送告警提醒，在实际达到临界时，拒绝更多请求压垮服务；</p>
<p>通过配置服务熔断，可以在我们的服务达到容量极限无法支撑时，保护系统不再受到更多请求流量的冲击；</p>
<p>通过配置防重复和接口缓存，可以在一定程度上减少涌向服务的请求数，避免过多的资源消耗。</p>
<p>以上，不论是来自外部系统的正常还是非正常高并发请求时，过载的网络请求都不会直接涌至我们的服务，而是被 api 网关给拦截或拒绝了回去，从而实现对我们自身业务系统和平台的保护，不至于由于网络过载而导致请求雪崩，系统不可用。</p>
<h3 id="防御性编程"><a href="#防御性编程" class="headerlink" title="防御性编程"></a>防御性编程</h3><p>跟上文“应用安全-请求签名”一节中一样，我们除了对接口请求应当持不信任的态度之外，我们也应该对内部 api、method 的调用方持不信任的态度。此时就需要防御性设计和防御性编程的思想，以此来保证我们的程序能够适应更广泛的输入错误，不至于在意外输入时而崩溃。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上简略地描述了做好系统安全设计和系统保护设计需要做的工作，具体没有展开。在实际工作中由于各个项目的安全级别、网络环境等不用，也可能导致实际能够落地的部分难以面面俱到，此时需要仔细分析我们系统的薄弱和风险环节，有针对性地采取措施，详细深入地做好对应的防护。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2019/05/07/%E8%AE%BE%E7%BD%AE-Windows-10-%E5%AD%90%E7%B3%BB%E7%BB%9F%E9%80%9A%E8%BF%87%E4%BB%A3%E7%90%86%E4%B8%8A%E7%BD%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/07/%E8%AE%BE%E7%BD%AE-Windows-10-%E5%AD%90%E7%B3%BB%E7%BB%9F%E9%80%9A%E8%BF%87%E4%BB%A3%E7%90%86%E4%B8%8A%E7%BD%91/" class="post-title-link" itemprop="url">设置 Windows 10 子系统通过代理上网</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-07 11:09:12" itemprop="dateCreated datePublished" datetime="2019-05-07T11:09:12+08:00">2019-05-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="安装-Windows-10-Ubuntu-子系统"><a href="#安装-Windows-10-Ubuntu-子系统" class="headerlink" title="安装 Windows 10 Ubuntu 子系统"></a>安装 Windows 10 Ubuntu 子系统</h2><p>（网上很多教程，略）</p>
<h2 id="设置代理上网"><a href="#设置代理上网" class="headerlink" title="设置代理上网"></a>设置代理上网</h2><p>如果 Windows 10 本身就通过代理上网，则子系统默认是无法上网的，仍然需要设置代理。</p>
<h3 id="设置-apt-的代理"><a href="#设置-apt-的代理" class="headerlink" title="设置 apt 的代理"></a>设置 apt 的代理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;Acquire::http::Proxy &quot;http://myproxy.com:8080&quot;;&#x27;</span> | sudo tee /etc/apt/apt.conf.d/my-proxy.conf</span><br></pre></td></tr></table></figure>

<h3 id="设置其他代理"><a href="#设置其他代理" class="headerlink" title="设置其他代理"></a>设置其他代理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export http_proxy=&#x27;myproxy.com:8080&#x27;&quot;</span> | sudo tee -a ~/.bashrc</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2019/01/25/Protobuf-gRPC-gRPC-Gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/01/25/Protobuf-gRPC-gRPC-Gateway/" class="post-title-link" itemprop="url">Protobuf & gRPC & gRPC-Gateway</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-25 15:03:01" itemprop="dateCreated datePublished" datetime="2019-01-25T15:03:01+08:00">2019-01-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Protobuf-amp-gRPC-amp-gRPC-Gateway"><a href="#Protobuf-amp-gRPC-amp-gRPC-Gateway" class="headerlink" title="Protobuf &amp; gRPC &amp; gRPC-Gateway"></a>Protobuf &amp; gRPC &amp; gRPC-Gateway</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li><p>安装 protoc，下载地址：<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases">https://github.com/protocolbuffers/protobuf/releases</a></p>
<p>根据自己的系统下载相应的 protoc，windows 用户统一下载 win32 版本。</p>
</li>
<li><p>配置 protoc 到系统的环境变量中，执行如下命令查看是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ protoc --version</span><br><span class="line">libprotoc 3.6.1</span><br></pre></td></tr></table></figure></li>
<li><p>安装 ProtoBuf 相关的 golang 依赖库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用于根据 protobuf 生成 golang 代码，语法 protoc --go_out=. *.proto</span></span><br><span class="line">$ go get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure></li>
<li><p>安装语法支持、代码高亮和代码格式化插件</p>
<p>安装 VSC 插件：</p>
<ul>
<li>vscode-proto3</li>
<li>Clang-Format</li>
</ul>
<p>安装命令行工具</p>
<ul>
<li>clang-format：<code>npm install -g clang-format</code></li>
</ul>
</li>
</ol>
<h2 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h2><ol>
<li><p>编写 protobuf 代码 <code>./pb/user/profile-service.proto</code>。（<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">语法参考</a>）</p>
<p>详细代码示例见下文。</p>
</li>
<li><p>生成 *.pb.go 代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 message</span></span><br><span class="line">$ protoc --go_out=. ./pb/**/*.proto</span><br></pre></td></tr></table></figure>

<p>详细命令参数见：<a target="_blank" rel="noopener" href="https://github.com/golang/protobuf">https://github.com/golang/protobuf</a></p>
<p>通过以上命令把<code>./pb/user/profile-service.proto</code>生成了<code>./api/user/profile-service.pb.go</code>文件。至此，我们生成了 go 代码，其中生成的 struct 和相关的方法都可以在 go 工程里正常使用。</p>
</li>
</ol>
<h2 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h2><ol>
<li><p>生成 <code>*.pb.go</code> 代码。</p>
<p>您可能已经发现了，上面生成的代码中找不到我们定义的 service <code>ProfileService</code>，其中的两个方法也找不到。这是为什么呢？是因为我们执行 protoc 命令时，没有指定支持 grpc 的插件，指定支持 grpc 的插件之后，即会生成服务相关代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 message 和 service（支持gRPC）</span></span><br><span class="line">$ protoc --go_out=plugins=grpc:. ./pb/**/*.proto</span><br></pre></td></tr></table></figure>

<p>执行上述命令之后，您会发现生成的 go 文件里，多出了与 <code>ProfileServiceServer</code>、<code>ProfileServiceClient</code> 相关的 struct 和 interface，也多出了我们 <code>GetProfile</code>、<code>Logout</code> 两个方法相关的代码。</p>
</li>
<li><p>编写服务端和客户端代码</p>
<p>服务端代码：<code>./grpc/server/server.go</code>，客户端代码：<code>./grpc/grpc-client/client.go</code>，详细代码见下文。</p>
</li>
<li><p>运行效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行 gRPC 服务</span></span><br><span class="line">$ go run ./grpc/server/server.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 gRPC 客户端，调用服务端</span></span><br><span class="line">$ go run ./grpc/grpc-client/client.go</span><br><span class="line">Login: <span class="literal">true</span></span><br><span class="line">Greeting: austinluo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 gRPC 客户端，调用服务端</span></span><br><span class="line">$ go run ./grpc/grpc-client/client.go admin</span><br><span class="line">Login: <span class="literal">true</span></span><br><span class="line">Greeting: admin</span><br></pre></td></tr></table></figure></li>
</ol>
<p>至此，基于 gRPC 通信的服务端和客户端均已经建立起来。</p>
<h2 id="gRPC-Gateway"><a href="#gRPC-Gateway" class="headerlink" title="gRPC Gateway"></a>gRPC Gateway</h2><p>如果我们的 gRPC 服务希望通过 HTTP 协议公开出来，以供现有的其他服务调用，那么我们就需要用到 gRPC Gateway。它是 Google 官方提供的一个反向代理，核心功能是提供 HTTP 接口，将接收到的 JSON 请求解码再编码为 pb 二进制格式，然后通过 gRPC 调用服务端，服务端返回了 pb 二进制的响应之后，它再次解码编码为 HTTP 响应体返回到客户端。</p>
<p>如下为实现的过程示例。</p>
<ol>
<li><p>安装：<a target="_blank" rel="noopener" href="https://github.com/grpc-ecosystem/grpc-gateway">https://github.com/grpc-ecosystem/grpc-gateway</a></p>
</li>
<li><p>在 proto 文件中添加<code>google.api.http</code>相关描述</p>
</li>
<li><p>执行 protoc 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">protoc \</span><br><span class="line">  -I. \</span><br><span class="line">  -I<span class="variable">$GOPATH</span>/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \</span><br><span class="line">  --go_out=plugins=grpc:. \</span><br><span class="line">  --grpc-gateway_out=logtostderr=<span class="literal">true</span>:. \</span><br><span class="line">  ./pb/**/*.proto</span><br></pre></td></tr></table></figure>

<p>至此，除了生成了上文所说的<code>./api/user/profile-service.pb.go</code>，也生成了<code>./api/user/profile-service.pb.gw.go</code> 文件，该文件即可用于创建 HTTP 反向代理。</p>
</li>
<li><p>创建 HTTP 反向代理服务 <code>./grpc/grpc-gateway/http_proxy.go</code>。详细代码见下文。</p>
</li>
<li><p>运行效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行 gRPC 服务</span></span><br><span class="line">$ go run ./grpc/server/server.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 gRPC-gateway 反向代理</span></span><br><span class="line">$ go run ./grpc/grpc-gateway/http_proxy.go</span><br></pre></td></tr></table></figure>

<p>发起请求，执行 Login：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /v1/login</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">accept-encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">content-length</span><span class="punctuation">: </span>46</span><br><span class="line"></span><br><span class="line">&#123; &quot;name&quot;: &quot;austinluo&quot;, &quot;password&quot;: &quot;12345&quot; &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span><br><span class="line"><span class="attribute">status</span><span class="punctuation">: </span>200</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Grpc-Metadata-Content-Type</span><span class="punctuation">: </span>application/grpc</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 25 Jan 2019 06:35:27 GMT</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>11</span><br><span class="line"></span><br><span class="line">&#123;&quot;ok&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>发起请求，执行 GetProfile：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /v1/profile</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">accept-encoding</span><span class="punctuation">: </span>gzip, deflate</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span><br><span class="line"><span class="attribute">status</span><span class="punctuation">: </span>200</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Grpc-Metadata-Content-Type</span><span class="punctuation">: </span>application/grpc</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 25 Jan 2019 06:41:19 GMT</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>66</span><br><span class="line"></span><br><span class="line">&#123;&quot;profile&quot;:&#123;&quot;user&quot;:&#123;&quot;staff_id&quot;:&quot;61050&quot;,&quot;staff_name&quot;:&quot;austinluo&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>至此，支持 HTTP 请求的 gRPC Gateway 搭建成功，可以通过它访问 gRPC 服务了。</p>
</li>
</ol>
<h2 id="附：完整代码："><a href="#附：完整代码：" class="headerlink" title="附：完整代码："></a>附：完整代码：</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./pb/user/profile-service.proto</span></span><br><span class="line"></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> api.user;</span><br><span class="line"></span><br><span class="line">option go_package = <span class="string">&quot;api/user&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/api/annotations.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">service ProfileService &#123;</span><br><span class="line">  rpc GetProfile(GetProfileReq) returns (GetProfileRes) &#123;</span><br><span class="line">    option (google.api.http) = &#123;</span><br><span class="line">      get : <span class="string">&quot;/v1/profile&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  rpc Login(LoginReq) returns (LoginRes) &#123;</span><br><span class="line">    option (google.api.http) = &#123;</span><br><span class="line">      post : <span class="string">&quot;/v1/login&quot;</span>,</span><br><span class="line">      body : <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message GetProfileReq &#123;&#125;</span><br><span class="line">message GetProfileRes &#123; Profile profile = <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">message LoginReq &#123;</span><br><span class="line">  <span class="keyword">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">string</span> password = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">message LoginRes &#123; <span class="keyword">bool</span> ok = <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note that the generated Go field names always use camel-case naming, even if</span></span><br><span class="line"><span class="comment">// the field name in the .proto file uses lower-case with underscores (as it should).</span></span><br><span class="line"><span class="comment">// https://developers.google.com/protocol-buffers/docs/reference/go-generated</span></span><br><span class="line">message Staff &#123;</span><br><span class="line">  <span class="keyword">string</span> staff_id = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">string</span> staff_name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Profile &#123;</span><br><span class="line">  Staff user = <span class="number">1</span>;</span><br><span class="line">  repeated <span class="keyword">string</span> permissions = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./grpc/server/server.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;errors&quot;</span></span><br><span class="line">  <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">  pb <span class="string">&quot;git.code.oa.com/fip-team/rasse/api/user&quot;</span></span><br><span class="line">  <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">  <span class="string">&quot;google.golang.org/grpc/reflection&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  port = <span class="string">&quot;:50051&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">HACK:</span> the logged in user name</span></span><br><span class="line"><span class="comment">// it should be kept in a state management system with session.</span></span><br><span class="line"><span class="keyword">var</span> loggedinUser <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">HACK:</span> the password for users</span></span><br><span class="line"><span class="keyword">const</span> password = <span class="string">&quot;12345&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">GetProfile</span><span class="params">(ctx context.Context, in *pb.GetProfileReq)</span> <span class="params">(*pb.GetProfileRes, error)</span></span> &#123;</span><br><span class="line">  user := &amp;pb.Staff&#123;StaffId: <span class="string">&quot;61050&quot;</span>, StaffName: loggedinUser&#125;</span><br><span class="line">  permissions := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;pb.GetProfileRes&#123;</span><br><span class="line">    Profile: &amp;pb.Profile&#123;</span><br><span class="line">      User:        user,</span><br><span class="line">      Permissions: permissions,</span><br><span class="line">    &#125;&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">Login</span><span class="params">(ctx context.Context, in *pb.LoginReq)</span> <span class="params">(*pb.LoginRes, error)</span></span> &#123;</span><br><span class="line">  log.Printf(<span class="string">&quot;Received: %v&quot;</span>, in.String())</span><br><span class="line">  <span class="keyword">if</span> in.Password == password &#123;</span><br><span class="line">    loggedinUser = in.Name</span><br><span class="line">    <span class="keyword">return</span> &amp;pb.LoginRes&#123;Ok: <span class="literal">true</span>&#125;, <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;password error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, port)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to listen: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  s := grpc.NewServer()</span><br><span class="line">  pb.RegisterProfileServiceServer(s, &amp;server&#123;&#125;)</span><br><span class="line">  <span class="comment">// Register reflection service on gRPC server.</span></span><br><span class="line">  reflection.Register(s)</span><br><span class="line">  <span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to serve: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./grpc/grpc-client/client.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">  <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">  pb <span class="string">&quot;git.code.oa.com/fip-team/rasse/api/user&quot;</span></span><br><span class="line">  <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">  address         = <span class="string">&quot;localhost:50051&quot;</span></span><br><span class="line">  defaultName     = <span class="string">&quot;austinluo&quot;</span></span><br><span class="line">  defaultPassword = <span class="string">&quot;12345&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// Set up a connection to the server.</span></span><br><span class="line">  conn, err := grpc.Dial(address, grpc.WithInsecure())</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;did not connect: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> conn.Close()</span><br><span class="line">  c := pb.NewProfileServiceClient(conn)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Contact the server and print out its response.</span></span><br><span class="line">  name := defaultName</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">    name = os.Args[<span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ctx, cancel := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">  <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">  resLogin, err := c.Login(ctx, &amp;pb.LoginReq&#123;Name: name, Password: defaultPassword&#125;)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;could not login: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  log.Printf(<span class="string">&quot;Login: %v&quot;</span>, resLogin.Ok)</span><br><span class="line"></span><br><span class="line">  resProfile, err := c.GetProfile(ctx, &amp;pb.GetProfileReq&#123;&#125;)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;could not get profile: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">  log.Printf(<span class="string">&quot;Greeting: %s&quot;</span>, resProfile.Profile.User.StaffName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./grpc/grpc-gateway/http_proxy.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;flag&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/golang/glog&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/grpc-ecosystem/grpc-gateway/runtime&quot;</span></span><br><span class="line">  <span class="string">&quot;golang.org/x/net/context&quot;</span></span><br><span class="line">  <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">  gw <span class="string">&quot;git.code.oa.com/fip-team/rasse/api/user&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  echoEndpoint = flag.String(<span class="string">&quot;echo_endpoint&quot;</span>, <span class="string">&quot;localhost:50051&quot;</span>, <span class="string">&quot;endpoint of YourService&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  ctx := context.Background()</span><br><span class="line">  ctx, cancel := context.WithCancel(ctx)</span><br><span class="line">  <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">  mux := runtime.NewServeMux()</span><br><span class="line">  opts := []grpc.DialOption&#123;grpc.WithInsecure()&#125;</span><br><span class="line">  err := gw.RegisterProfileServiceHandlerFromEndpoint(ctx, mux, *echoEndpoint, opts)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, mux)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line">  <span class="keyword">defer</span> glog.Flush()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    glog.Fatal(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>gRPC Go Quick Start: <a target="_blank" rel="noopener" href="https://grpc.io/docs/quickstart/go.html">https://grpc.io/docs/quickstart/go.html</a></li>
<li>Go support for Protocol Buffers: <a target="_blank" rel="noopener" href="https://github.com/golang/protobuf">https://github.com/golang/protobuf</a></li>
<li>Language Guide (proto3): <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">https://developers.google.com/protocol-buffers/docs/proto3</a></li>
<li>grpc-gateway: <a target="_blank" rel="noopener" href="https://github.com/grpc-ecosystem/grpc-gateway">https://github.com/grpc-ecosystem/grpc-gateway</a></li>
<li>gRPC in 3 minutes (Go): <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go/tree/master/examples">https://github.com/grpc/grpc-go/tree/master/examples</a></li>
<li>grpc examples of gin-gonic/gin: <a target="_blank" rel="noopener" href="https://github.com/gin-gonic/gin/tree/master/examples/grpc">https://github.com/gin-gonic/gin/tree/master/examples/grpc</a></li>
<li>Package google.api(google.api.http): <a target="_blank" rel="noopener" href="https://cloud.google.com/service-infrastructure/docs/service-management/reference/rpc/google.api#google.api.HttpRule">https://cloud.google.com/service-infrastructure/docs/service-management/reference/rpc/google.api#google.api.HttpRule</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2019/01/23/Using-portable-commands-like-zip-tar-on-Windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/01/23/Using-portable-commands-like-zip-tar-on-Windows/" class="post-title-link" itemprop="url">Using portable commands like zip/tar on Windows</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-23 19:39:55" itemprop="dateCreated datePublished" datetime="2019-01-23T19:39:55+08:00">2019-01-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="在-Windows-上使用-Mac-Linux-上的-zip-tar-等命令"><a href="#在-Windows-上使用-Mac-Linux-上的-zip-tar-等命令" class="headerlink" title="在 Windows 上使用 Mac/Linux 上的 zip/tar 等命令"></a>在 Windows 上使用 Mac/Linux 上的 zip/tar 等命令</h1><p>开发时时而在 MAC、Linux 上，时而在 Windows 上，脚本执行环境无法统一是个大问题。所幸我们使用的 Git 中带有 MINGW32（或安装 CYGWIN），这里面已经有很多的非 Windows 平台命令了。</p>
<p>但是在使用过程中，还是有一些命令是缺失的，比如 <code>zip</code>，此时我们可以自行下载他们（<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/gnuwin32/files/">下载地址</a>），下载之后，将可执行的 exe 文件和相关依赖文件，放到 MING32/CYGWIN 的 bin 目录中即可。</p>
<p>附：</p>
<ul>
<li>Git 的 MINGW32 默认安装目录：C:\Program Files (x86)\Git\mingw32\bin</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2018/12/04/%E5%B0%86%E4%BB%A3%E7%A0%81%E4%BB%8E-SVN-%E8%BF%81%E7%A7%BB%E5%88%B0-GIT-%E5%B9%B6%E4%BF%9D%E7%95%99%E6%8F%90%E4%BA%A4%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/04/%E5%B0%86%E4%BB%A3%E7%A0%81%E4%BB%8E-SVN-%E8%BF%81%E7%A7%BB%E5%88%B0-GIT-%E5%B9%B6%E4%BF%9D%E7%95%99%E6%8F%90%E4%BA%A4%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">将代码从 SVN 迁移到 GIT 并保留提交记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-04 17:25:44" itemprop="dateCreated datePublished" datetime="2018-12-04T17:25:44+08:00">2018-12-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="第一步：用户映射"><a href="#第一步：用户映射" class="headerlink" title="第一步：用户映射"></a>第一步：用户映射</h1><p>创建用户映射 （例如 users.txt） ，将 SVN 用户和 Git 用户对应起来，为保留提交记录做准备。</p>
<p>进入 SVN 的目录，执行如下命令，注意其中 <code>$1\@your-company.com</code> 部分应当替换为你实际的映射关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ svn <span class="built_in">log</span> --xml | grep -P <span class="string">&quot;^&lt;author&quot;</span> | sort -u | \</span><br><span class="line">    perl -pe <span class="string">&#x27;s/&lt;author&gt;(.*?)&lt;\/author&gt;/$1 = $1 &lt;$1\@your-company.com&gt;/&#x27;</span> &gt; users.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"></span><br><span class="line">$ svn <span class="built_in">log</span> -q svn+ssh://your/svn/path | \</span><br><span class="line">    awk -F <span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;/^r/ &#123;sub(&quot;^ &quot;, &quot;&quot;, $2); sub(&quot; $&quot;, &quot;&quot;, $2); print $2&quot; = &quot;$2&quot; &lt;&quot;$2&quot;@your-company.com&gt;&quot;&#125;&#x27;</span> | \</span><br><span class="line">    sort -u &gt; users.txt</span><br></pre></td></tr></table></figure>

<p>注意，生成的 users.txt 文件应当以 ANSI 编码保存，并且使用 CRLF 换行，您可以使用记事本另存为的功能选择该编码。</p>
<h1 id="第二步：克隆代码"><a href="#第二步：克隆代码" class="headerlink" title="第二步：克隆代码"></a>第二步：克隆代码</h1><p>创建一个用于存放 Git 本地仓库的文件夹，如：<code>E:/git</code>，进入该文件夹，执行 <code>clone</code> 命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /e/git</span><br><span class="line">git svn <span class="built_in">clone</span> svn+ssh://your/svn/path -r 2000:HEAD --no-metadata --authors-file=users.txt --trunk=.</span><br></pre></td></tr></table></figure>

<p>该步骤除了 clone 代码之外，还将导入所有的提交记录，执行较慢，需要耐心等待。中途出现找不到作者的情况时，可以修改 <code>users.txt</code> 补充该作者，重新再执行 <code>git svn clone</code> 命令。</p>
<p>详细命令参数，请参考 <code>git svn help clone</code>。</p>
<p>执行完成之后，会在 <code>E:/git</code> 目录下创建以你 SVN path 最后一节为名称的子目录，可以进入该目录下的 <code>.git</code> 文件夹，执行 <code>git log</code> 命令查看提交记录。</p>
<h1 id="第三步：提交到-GIT"><a href="#第三步：提交到-GIT" class="headerlink" title="第三步：提交到 GIT"></a>第三步：提交到 GIT</h1><p>这个步骤和常规地创建 GIT 仓库没有任何区别，直接添加远程仓库地址，push 即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin http://your/remote/git/path.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<p>至此，代码及提交记录从 SVN 迁移到 GIT 的工作全部完成。</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gitee.com/progit/8-Git-%E4%B8%8E%E5%85%B6%E4%BB%96%E7%B3%BB%E7%BB%9F.html#8.2-%E8%BF%81%E7%A7%BB%E5%88%B0-Git">https://gitee.com/progit/8-Git-%E4%B8%8E%E5%85%B6%E4%BB%96%E7%B3%BB%E7%BB%9F.html#8.2-%E8%BF%81%E7%A7%BB%E5%88%B0-Git</a></li>
<li><a target="_blank" rel="noopener" href="https://www.lovelucy.info/codebase-from-svn-to-git-migration-keep-commit-history.html">https://www.lovelucy.info/codebase-from-svn-to-git-migration-keep-commit-history.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2018/10/27/%E3%80%90%E8%AF%91%E3%80%91Go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%EF%BC%9A%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BB%BA%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/10/27/%E3%80%90%E8%AF%91%E3%80%91Go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%EF%BC%9A%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BB%BA%E8%AE%AE/" class="post-title-link" itemprop="url">【译】Go 语言实践：编写可维护的程序的建议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-10-27 23:08:18" itemprop="dateCreated datePublished" datetime="2018-10-27T23:08:18+08:00">2018-10-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2018-11-25 18:01:18" itemprop="dateModified" datetime="2018-11-25T18:01:18+08:00">2018-11-25</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>译者注</strong></p>
<p>本文为 <strong>QCon 2018 上海站</strong>主题演讲嘉宾、Heptio 资深工程师、著名 Go 语言专家 <a target="_blank" rel="noopener" href="https://2018.qconshanghai.com/speaker/2503">David Cheney</a> 关于 Go 语言实践的英文分享。为方便大家阅读，在此由 <a href="https://www.udnz.com/">Austin Luo</a> 翻译为中文，在文中难以理解之处，也特别增加了译者的理解说明。翻译水平有限，如有偏颇之处，烦请联系我（<a href="mailto:&#x75;&#111;&#110;&#117;&#110;&#64;&#x31;&#54;&#51;&#x2e;&#x63;&#x6f;&#109;">&#x75;&#111;&#110;&#117;&#110;&#64;&#x31;&#54;&#51;&#x2e;&#x63;&#x6f;&#109;</a>）更正。转载请注明出处，保留本节译者注。</p>
<hr>
<p><strong>目录</strong></p>
<ul>
<li>指导原则<ul>
<li>简单性</li>
<li>可读性</li>
<li>生产率</li>
</ul>
</li>
<li>标识符<ul>
<li>选择清晰的名称，而不是简洁的名称</li>
<li>标识符长度</li>
<li>命名中不要包含所属类型的名称</li>
<li>使用一致的命名风格</li>
<li>使用一致的声明风格</li>
<li>成为团队合作者</li>
</ul>
</li>
<li>代码注释<ul>
<li>变量和常量上的注释应当描述它的内容，而非目的</li>
<li>总是为公开符号写文档说明</li>
</ul>
</li>
<li>包的设计<ul>
<li>一个好的包从它的名称开始</li>
<li>避免将包命名为 base、common、util</li>
<li>快速返回，而不是深层嵌套</li>
<li>让零值变得有意义</li>
<li>避免包级别的状态</li>
</ul>
</li>
<li>项目结构<ul>
<li>考虑更少，更大的包</li>
<li>确保 main 包越小越好</li>
</ul>
</li>
<li>API 设计<ul>
<li>设计难以被误用的 API</li>
<li>针对默认用例设计 API</li>
<li>让函数自身定义它所需的行为</li>
</ul>
</li>
<li>错误处理<ul>
<li>通过消除错误来消除错误处理</li>
<li>错误只处理一次</li>
</ul>
</li>
<li>并发<ul>
<li>保持自己忙碌，否则自己做</li>
<li>将并发留给调用者</li>
<li>不要启动一个永不停止的协程</li>
</ul>
</li>
</ul>
<p><strong>引言</strong></p>
<p>接下来这两场我将给大家一些编写 Go 代码的最佳实践。</p>
<p>今天这是一个研讨会风格的演讲，我会摒弃那些绚丽的 PPT，而是使用您们可以直接带走的文档。</p>
<blockquote>
<p>您可以在这里找到这个演讲最新的在线版本：<br><a target="_blank" rel="noopener" href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a></p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/10/27/%E3%80%90%E8%AF%91%E3%80%91Go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E8%B7%B5%EF%BC%9A%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%BB%BA%E8%AE%AE/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2018/10/08/%E5%9C%A8-Visual-Studio-Code-%E4%B8%AD%E4%BD%BF%E7%94%A8-MINGW32-%E4%BD%9C%E4%B8%BA%E7%BB%88%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/10/08/%E5%9C%A8-Visual-Studio-Code-%E4%B8%AD%E4%BD%BF%E7%94%A8-MINGW32-%E4%BD%9C%E4%B8%BA%E7%BB%88%E7%AB%AF/" class="post-title-link" itemprop="url">在 Visual Studio Code 中使用 MINGW32 作为终端</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-10-08 17:09:18 / 修改时间：17:10:12" itemprop="dateCreated datePublished" datetime="2018-10-08T17:09:18+08:00">2018-10-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>打开 Visual Studio Code 的设置，按如下配置即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 找到您的 git 目录</span></span><br><span class="line">  <span class="attr">&quot;terminal.integrated.shell.windows&quot;</span>: <span class="string">&quot;C:\\Program Files (x86)\\Git\\bin\\bash.exe&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;terminal.integrated.shellArgs.windows&quot;</span>: [<span class="string">&quot;--login&quot;</span>, <span class="string">&quot;-i&quot;</span>],</span><br><span class="line">  <span class="comment">// 需要的环境变量</span></span><br><span class="line">  <span class="attr">&quot;terminal.integrated.env.windows&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;HOME&quot;</span>: <span class="string">&quot;/d/austinluo/Documents/githome&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>附：</p>
<p>我自己修改了当前用户的个人文件夹，通过上述方式可以解决 VSC 中 terminal 的 HOME 位置不对的问题（可以正常加载 .ssh 及相关的 key），但 VSC 默认自带的 Git 仍然会找到系统默认位置的个人文件夹，这个可以通过 junction 命令来解决：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在系统默认的个人文件夹下创建迁移过的新位置的软连接</span></span><br><span class="line">junction64.exe -s C:\Users\austinluo\Documents -s D:\austinluo\Documents</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过注册表完整设置和迁移个人文件夹位置可能不会出现上述情况。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.udnz.com/2018/10/06/Linux-%E7%8E%AF%E5%A2%83%E4%B8%80%E9%94%AE%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/934574?s=400&u=e82170d672ed95a22dfe72374fde752cf973b785&v=4">
      <meta itemprop="name" content="Austin Luo">
      <meta itemprop="description" content="架构师，腾讯<br />专注微服务和软件基础设施建设">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="UDNZ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/10/06/Linux-%E7%8E%AF%E5%A2%83%E4%B8%80%E9%94%AE%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">Linux 环境一键打包发布脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-10-06 18:16:28" itemprop="dateCreated datePublished" datetime="2018-10-06T18:16:28+08:00">2018-10-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>以下脚本作为工作笔记沉淀，记录一下。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/10/06/Linux-%E7%8E%AF%E5%A2%83%E4%B8%80%E9%94%AE%E6%89%93%E5%8C%85%E5%8F%91%E5%B8%83%E8%84%9A%E6%9C%AC/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">udnz.com</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  





</body>
</html>
